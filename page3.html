





<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Page 4 &mdash; Whitewashing</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.4.1b',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/disqus.js"></script>
    <script type="text/javascript" src="_static/ga.js"></script>
    <link rel="shortcut icon" href="_static/tinkerer.ico"/>
    
    <link rel="top" title="Whitewashing" href="index.html" />
    <link rel="next" title="Older" href="page4.html" />
    <link rel="prev" title="Newer" href="page2.html" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /> 
  </head>
  <body>
<div class="container">
    <div id="header" class="span-8">
        <a href="index.html"><img src="_static/logo.jpg" alt="Whitewashing.de" /></a>
    </div>
    <div class="span-11" id="about">
        <p>Whitewashing is the blog of Benjamin Eberlei and covers topics in software-development, programming and databases.</p>
    </div>
    <div class="span-5 last">
        <p class="buttons" style="text-align: right">
            <a href="https://twitter.com/beberlei"><img src="_static/twitter-logo.png" alt="Follow me on twitter" height="50" /></a>
            <a href="http://www.whitewashing.de/rss.xml"><img src="_static/rss2.png" alt="Subscribe to RSS" height="50" /></a>
            <a href="https://github.com/beberlei"><img src="_static/github-logo.png" alt="My Github Profile" height="50" /></a>
        </p>
    </div>
</div>



    <div class="document">
<div class="container">
    
    <div class="span-24 content">
      <div>
        <div>
          <div id="page3">
            
            
    
    <div class="related">
        <ul>
            <li>
                 &laquo; <a href="page2.html">Newer</a>
            </li>
            <li class="right">
                <a href="page4.html">Older</a> &raquo; 
            </li>
        </ul>
    </div>
        
        <div class="timestamp postmeta">
            <span>January 14, 2009</span> 
        </div>
        <div class="section" id="finally-zend-mail-charset-and-or-long-lines-header-encoding-bug-fixed">
<h1><a href="2009/01/14/finally-zend-mail-charset-and-or-long-lines-header-encoding-bug-fixed.html">Finally: Zend_Mail charset and/or long lines header encoding bug fixed</a></h1>
<p>There was this <a class="reference external" href="http://framework.zend.com/issues/browse/ZF-1688">lurking bug in
Zend_Mail</a> which
destroyed every Mail-Header (and corresponding Mail) with non US-ASCII
Chars and more than an encoded length of 74 chars. This is quite a huge
subset of mails, but it seems a nice solution was not so easy, at least
nobody tried to fixed it for quite some time.</p>
<p>Where many hackish solutions we’re offered, Ota Mares aka Littlex spent
incredible time to hunt the original problem down and with his help I
tag-teamed the bug to death today. Saturo Yoshida of Zend Fame added
some further spice regarding an alternative solution with Base64
Encoding instead of Quoted Printable Mime Header encoding.</p>
<p>In the end the solution we chose was, not to re-use the Mime encoding
function that is specific to MIME bodies according to
<a class="reference external" href="http://tools.ietf.org/html/rfc2045">RFC2045</a>, but to write a
completely new algorithm for Mime Headers, whose rules are specified in
<a class="reference external" href="http://tools.ietf.org/html/rfc2047">RFC2047</a>. This is now done and
unit-tests prove its working according to standard.</p>
<p>What is missing now is people trying that fix on as many Mail platforms
as possible and <a class="reference external" href="http://framework.zend.com/issues/browse/ZF-1688">giving feedback in the
issue</a> if a lengthy
subject with non-ASCII chars is displayed correctly.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by beberlei <kontakt@beberlei.de></span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2009/01/14/finally-zend-mail-charset-and-or-long-lines-header-encoding-bug-fixed.html#disqus_thread" data-disqus-identifier="2009/01/14/finally-zend-mail-charset-and-or-long-lines-header-encoding-bug-fixed">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>January 11, 2009</span> 
        </div>
        <div class="section" id="howto-file-a-good-bug-report-suggestions-for-framework-users">
<h1><a href="2009/01/11/howto-file-a-good-bug-report-suggestions-for-framework-users.html">Howto file a good bug report: Suggestions for framework users</a></h1>
<p>I have fixed quite a number of bugs for the ZF lately, which lead me to
this post about how to file a good bug report. There are many annoying
bug reports out there, where the reporter of the bug withholds important
information to the bugfixer unintended. This advice applies bug reports
in general of course.</p>
<p>What are the benefits of a good bug report? The bug generally gets fixed
faster, when the developer has more information at hand. Additionally
other developers might come to rescue since they can understand the
issue faster. These benefits are good for both parties. If you take no
time for a good bug report, your issue might risk to end up getting old
or closed unfixed.</p>
<ul class="simple">
<li><strong>Post the whole Exception Stack Trace</strong>: If the library throws an
Exception into your application that is unexpected and may indicate
an bug: Do not post the Message or Exception name only. The exception
may be thrown in many different places or due to different reasons.
The PHP exception class offers the method <strong>getTraceAsString()</strong>,
which offers many information to the developer what the cause of the
exception might be. Please use it!</li>
<li><strong>Post codefixes in a patch format</strong>: When you find a bug in the
framework, it is quite possible that you can offer a fix directly.
Writing “Replace x in line y with z” does not help very often. The
component might be in flux and the line positions change more often
than you think. Please create a diff file of this changes that
indicate the precise position of the change. This diff also includes
2 lines above and below the patched code for direction of the
developer. SVN Diffs are even more useful since they include the
revision where you fixed the bug in.</li>
<li><strong>Post reproducible cases as PHPUnit Test</strong>: If you find a bug and
can show how to reproduce it: Write a unittest to prove it. It is ZF
policy to create a unittest for each bugfix showing that the bug was
indeed fixed and previous functionality remains the same, so this
unit-test has to be written anyways. Many show-offs rely on massive
<strong>echo</strong> statements or <strong>var_dump</strong>, which render them almost
useless for the developer.</li>
<li><strong>Attach a unit-test to a submitted patch</strong>: This is related to the
previous point. If you add a unit test your patch will get more
attention. It will prove that you have thought about the patch, its
consequences and that you might have checked it does not break
backwards compatibility. This is worth a lot.</li>
<li><strong>Run the test suite with your patch</strong>: If you want to provide a
patch. Run the testsuite of the Zend Framework. It might break
expected behaviour. When you post a patch that will break BC, it will
be recognized. Your bug report might be closed, which helps nobody.</li>
</ul>
<p>When you find a bug you have probably thought about it and how to fix
it. This is valuable information. Disregarding one of this points will
lead to missing information on part of the developer that he has to
“learn” again. This takes time, which may make your bug last longer than
it should.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by beberlei <kontakt@beberlei.de></span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2009/01/11/howto-file-a-good-bug-report-suggestions-for-framework-users.html#disqus_thread" data-disqus-identifier="2009/01/11/howto-file-a-good-bug-report-suggestions-for-framework-users">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>January 11, 2009</span> 
        </div>
        <div class="section" id="what-will-be-new-in-zf-1-8">
<h1><a href="2009/01/11/what-will-be-new-in-zf-1-8.html">What will be new in ZF 1.8</a></h1>
<p>In Februar or March 2009 the 1.8 version of the <a class="reference external" href="http://framework.zend.com">Zend
Framework</a> is schedulded to be released. I
have contributed some stuff already regarding ZendX_JQuery and
Zend_Soap.</p>
<p>Both components have seen numerous bugfixes and I managed to get the
JQuery helper down to zero open issues. I have also taken over the
<a class="reference external" href="http://framework.zend.com/wiki/display/ZFPROP/Zend_Json_Expr+to+allow+Javascript+Expressions+(functions)+to+be+encoded+using+Zend_Json">Zend_Json_Expr
proposal</a>,
which will be a huge benefit to everything JSON that can be done with
ZF. Foremost it is an integral part for the jQuery component which
heavily relies on javascript callbacks.</p>
<p>The Soap Autodiscover and WSDL classes compatibility with Java and .NET
has been optimized due to great user feedback, as well as some bugfixes
to the newly added WSDL type detection strategies.</p>
<p>Additionally I went on another bug killing spree and fixed around 20-30
old bugs in a wide range of different components.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by beberlei <kontakt@beberlei.de></span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2009/01/11/what-will-be-new-in-zf-1-8.html#disqus_thread" data-disqus-identifier="2009/01/11/what-will-be-new-in-zf-1-8">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>January 12, 2009</span> 
        </div>
        <div class="section" id="on-publishing-webservices-within-mvc-frameworks">
<h1><a href="2009/01/12/on-publishing-webservices-within-mvc-frameworks.html">On Publishing Webservices within MVC Frameworks</a></h1>
<p>Webservices are a very important part in today’s enterprise applications.
They tie applications of different age or programming languages together
or allow applications of different subcontracters to speak to each
other. Because they use HTTP, a stateless network protocol, considerable
overhead floods the pipes when you use them, which should be minimized.</p>
<p><a class="reference external" href="http://martinfowler.com">Martin Fowler</a> writes in his <a class="reference external" href="http://martinfowler.com/eaaCatalog/">PEAA
book</a>, that if you have the
option not to use distributed objects (which are implemented via
webservice) you should not distribute them. Considerable effort has to
be brought into keeping complex webservices performant.</p>
<p>Still people make mistakes about webservices all the time (me included
for example proposing a dispatcher for the ZF that could be used for
webservices).</p>
<p>When people report problems with the Zend Soap component they often post
a stripped down example that involes their webservice being instantiated
within a controller. This is a very bad decision based on different
arguments:</p>
<ul class="simple">
<li><strong>Dispatching overhead</strong>: Dispatching, Routing, Pre- and
Postfiltering is costly in all frameworks. You give up the
performance of having numerous PHP scripts that act as controller on
their own. You get centralized filtering, authentication and other
benefits. But those benefits generally do not aply to XML, JSON or
SOAP requests, because you cannot parse them or access their
properties. You give up the performance of a page controller for
webservices to gain mostly nothing.</li>
<li><strong>HTTP Request uselessness</strong>: Web frameworks work with HTTP request
objects. The request of webservices facilitates HTTP to act as a far
more complex request. No framework I know off, allows to work with
the webservice requests outside the Webservice handler. What a SOAP
or XML-RPC request does in your MVC is only get passed through
numerous costly stages that offer no benefit, before it hits the
target. Only the parsing of HTTP-Headers might offer additional
benefit, but the gain is low, since they are available to PHP scripts
at no cost.</li>
<li><strong>Webservices already seperate concerns</strong>: Take the PHP SOAPServer as
an example. It is an MVC application on its own, the controlling
aspect of the SOAPServer parses the SOAP Request and sends it to the
model, a class given by the user, which in turn works and returns the
result as an SOAP Response View. You have to decouple model and view
for a webservice handler otherwise it would generate invalid
responses. Why nest a perfectly separated operation into another one?
You gain no more of this additional separation, except performance
decrease.</li>
</ul>
<p>So what are good practices to implement webservices?</p>
<ul class="simple">
<li>Use a page controller that generates no MVC overhead. In context of
the Zend Framework: Add a new php script to your web root and add a
new route into your .htaccess file that redirectes the desired
location of the webservice to the script that overwrites the standard
catch-all incoming requests to the front controller script.</li>
<li>Use the proxy pattern and the invaluable __call() method to
implement wrapper objects for authentication and session management
of the webservice. These classes can easily be reused by all
webservice page controllers of your site. If you do your homework you
can even share parts of these objects inside your Web-MVC application
to keep the code DRY. Those proxies keep authentication logic out of
your service class.</li>
<li>Use the remote facade pattern to implement a few, powerful methods
that delegate the service request to underlying domain objects. Never
ever publish direct access to domain objects with your webservices.
As a rule of thumb, talking to a webservice during a logical
operation should never involve more than one or two calls. The first
call is for data fetching, the second for data saving. Authentication
should be handled via HTTP Authentication to save an additional call.</li>
</ul>
<p>If you follow these simple rules, you should get around the performance
issues that generally come with webservices, without loosing flexibility
at all.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by beberlei <kontakt@beberlei.de></span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2009/01/12/on-publishing-webservices-within-mvc-frameworks.html#disqus_thread" data-disqus-identifier="2009/01/12/on-publishing-webservices-within-mvc-frameworks">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>January 07, 2009</span> 
        </div>
        <div class="section" id="seven-things">
<h1><a href="2009/01/07/seven-things.html">Seven Things</a></h1>
<p>I have been tagged by
<a class="reference external" href="http://dolfschimmel.freeaqingme.com/?p=78">Freeaqingme</a> and the blog
letter machinery. So read on for seven things you probably may not know
about me.</p>
<ul class="simple">
<li>I will get my degree in some weeks, currently intensively writting on
my thesis. My major is economics though. I probably won’t get a job
with that sooner or later. I actually don’t want to, I have a job as
programmer already.</li>
<li>One christmas many years ago (Pentium PCs to 200Mhz were the coolest
thing around) i wished and wished for a computer for playing Command
and Conquer and stuff. What i got was a 3/86 i could only run crap
with. So i had to start programming.</li>
<li>In 11th grade (7 years ago) I took part in the german computer
science olympics (<a class="reference external" href="http://www.bwinf.de/uploads/media/bwi20/runde1/20bwinf.pdf">exercise still
online</a>)
using PHP and writing thousands of lines of nested aray and for loop
code and print the solution to the browser. No need to say I utterly
failed, because I didn’t know a bit about algorithms, pointers and
objects at all.</li>
<li>I have only learned about what good programming practices are (OO,
functional, whatever) really means in the last two years, spending
almost every free minute of those many i had on projects to test
around with patterns and programming styles.</li>
<li>I went to my first conference last year september, the IPC in Mainz,
getting to know lots of great people in the community.</li>
<li>I don’t have a license at all (<a class="reference external" href="http://blog.libssh2.org/index.php?/archives/122-Seven-Things.html">Reference to
Sara</a>).
I am afraid of driving cars, although I drive my bike through the
biggest crossroads in town like nuts.</li>
<li>I am a timeline oriented reader, having made me masterplans to read
both all the Discworld and Ian Rankin novels in the correct order to
not miss a single reference.</li>
</ul>
<p>Its sad that everyone I would want to tag was already tagged by someone
else, still for the head count:</p>
<ul class="simple">
<li><a class="reference external" href="http://weierophinney.net/matthew/">Matthew Weierophinney</a>, because
he helped me understand Zend Framework alot.</li>
<li><a class="reference external" href="http://www.dasprids.de/">Ben Scholzen</a>, because he is a fun guy to
be around <strong>#zftalk.dev</strong>.</li>
<li><a class="reference external" href="http://www.thomasweidner.com/flatpress/">Thomas Weidner</a>, because
I like his dedication towards his ZF components.</li>
<li><a class="reference external" href="http://kore-nordmann.de/blog.html">Kore Nordmann</a>, Bastian Feder
and Thomas Weinert, because I had great discussions with him on IPC.</li>
<li><a class="reference external" href="http://codeutopia.net/blog/">zomg aka Jani</a> because of his skills
to be referenced by PHPDeveloper.org (joke) and the good IRC
discussions.</li>
<li><a class="reference external" href="http://blogs.sun.com/netbeansphp/">Petr Pisl</a> because of the
awesome NetBeans PHP support.</li>
</ul>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by beberlei <kontakt@beberlei.de></span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2009/01/07/seven-things.html#disqus_thread" data-disqus-identifier="2009/01/07/seven-things">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>March 11, 2009</span> 
        </div>
        <div class="section" id="using-zend-soap-server-and-autodiscover-in-a-controller">
<h1><a href="2009/03/11/using-zend-soap-server-and-autodiscover-in-a-controller.html">Using Zend_Soap Server and Autodiscover in a Controller</a></h1>
<p>I am in a dilemma. I have condemned the usage of Zend_Soap_Server (or
any other webservice server handler) <a class="reference external" href="http://www.whitewashing.de/blog/articles/106">inside a Model-View-Controller
application</a> before.
Still I get questions about <a class="reference external" href="http://www.whitewashing.de/blog/articles/65">my old Zend_Soap_Server and
Zend_Soap_AutoDiscover
example</a> not working in
the MVC scenario. The following example provides you with a working Soap
server inside a Zend_Controller_Action, although I discourage the use
of it and would suggest using a dedicated script outside the dispatching
process to gain multitudes of performance, which webservices often
require.</p>
<blockquote>
<div><div class="highlight-python"><pre>require_once &quot;/path/to/HelloWorldService.php&quot;;

class MyDiscouragedSoapServerController extends Zend_Controller_Action
{
    public function serverAction()
    {
        $server = new Zend_Soap_Server(&quot;http://example.com/pathto/wsdl&quot;);
        $server-&gt;setClass('HelloWorldService');
        $server-&gt;handle();
    }

    public function wsdlAction()
    {
        $wsdl = new Zend_Soap_AutoDiscover();
        $wsdl-&gt;setUri('http://example.com/pathto/server');
        $wsdl-&gt;setClass('HelloWorldService');
        $wsdl-&gt;handle();
    }
}</pre>
</div>
</div></blockquote>
<p>Now all you have to do is create two routes, one that makes
<strong>http://example.com/pathto/server</strong> point to
<strong>MyDiscouragedSoapServerController::serverAction</strong> and the other route
that makes <strong>http://example.com/pathto/wsdl</strong> point to
<strong>MyDiscouragedSoapServerController::wsdlAction</strong>. The wrong version
(Version Mismatch) error comes from sending a request for the WSDL file
to the actual Soap Server, which he doesn’t like.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by beberlei <kontakt@beberlei.de></span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2009/03/11/using-zend-soap-server-and-autodiscover-in-a-controller.html#disqus_thread" data-disqus-identifier="2009/03/11/using-zend-soap-server-and-autodiscover-in-a-controller">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>March 27, 2009</span> 
        </div>
        <div class="section" id="test-your-legacy-php-application-with-function-mocks">
<h1><a href="2009/03/27/test-your-legacy-php-application-with-function-mocks.html">Test your Legacy PHP Application with Function Mocks!</a></h1>
<p>Much talking is going on about Unittesting, Mocks and TDD in the PHP
world. For the most this discussions surround object-oriented PHP code,
frameworks and applications.</p>
<p>Yet I would assert that the reality for PHP developers (me included) is
dealing with PHP 4, PHP 5 migrated, or non-object oriented legacy
applications which are near to impossible to bring under test. Still
this code works, is in production and needs maintenance and possibly
extension for new features.</p>
<p>For example many applications may still use <strong>mysql_*</strong> functions at
length inside their model or have multiple nested function levels
(Example: Wordpress). <a class="reference external" href="http://pecl.php.net/package/runkit">Runkit</a> to
the rescue: A PECL extension that can hack your running PHP code, such
that method or functions are repointed to execute new implementations.
Using this extension you can actually mock out internal PHP functions,
which is great to bring legacy code under test.</p>
<p>Consider this following proof of concept, <a class="reference external" href="http://github.com/padraic/runkit/tree/master">using the Runkit extension
build by Padraic Brady</a>
(the one from pecl.php.net does not compile on PHP 5.2), which replaces
the functionality of <strong>mysql_query()</strong>. You have to set the following
option in your php.ini: <strong>runkit.internal_override = On</strong> for this to
work. By default only user-defined functions may be overwritten by
Runkit.</p>
<blockquote>
<div><div class="highlight-python"><pre>class FunctionMocker
{
    protected $_mockedFuncBehaviourMap = array();

    public function mock($funcName, $return=null)
    {
        $newFuncCode = 'return &quot;'.$return.'&quot;;';

        $renamedName = &quot;__&quot;.$funcName.&quot;_mockOriginalCopy&quot;;
        runkit_function_copy($funcName, $renamedName);
        runkit_function_redefine($funcName, '', $newFuncCode);

        $this-&gt;_mockedFuncBehaviourMap[$funcName] = $renamedName;
    }

    public function reset()
    {
        foreach($this-&gt;_mockedFuncBehaviourMap AS $funcName =&gt; $renamedName) {
            runkit_function_remove($funcName);
            runkit_function_copy($renamedName, $funcName);
            runkit_function_remove($renamedName);
        }
        $this-&gt;_mockedFuncBehaviourMap = array();
    }
}

$mocker = new FunctionMocker();
$mocker-&gt;mock('mysql_query', 'hello world!');

echo mysql_query(); // hello world

$mocker-&gt;reset();

mysql_query(); // error</pre>
</div>
<p>This example, only allows for string return values of the mock and
has no support for replacing the arguments of the mocked function.
Also chaining of different return values based on input or call
number might be interesting. Some kind of Code Generator Tool would
have to be implemented to support this functionality. Additionally
Assertions and Verifying should be implemented for the function
arguments. All in all this would allow to mock functions as you
would mock interfaces/classes, which would be a great addition for
all those legacy applications that use procedural PHP.</p>
<p>Additionally what the real killer for runkit would be: The
possibility to insert PHP callbacks instead of real PHP code into
the <strong>runkit_function_redefine</strong>.</p>
</div></blockquote>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by beberlei <kontakt@beberlei.de></span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2009/03/27/test-your-legacy-php-application-with-function-mocks.html#disqus_thread" data-disqus-identifier="2009/03/27/test-your-legacy-php-application-with-function-mocks">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>March 10, 2009</span> 
        </div>
        <div class="section" id="speaking-about-framework-quality-on-the-ipc-spring-09">
<h1><a href="2009/03/10/speaking-about-framework-quality-on-the-ipc-spring-09.html">Speaking about Framework Quality on the IPC Spring 09</a></h1>
<p>Just a short notice, my thesis is taking its last breath, I will be
speaking on the <a class="reference external" href="http://www.phpconference.com">IPC Spring 09
conference</a> in Berlin end of may this
year on Framework Quality and Unittests:</p>
<blockquote>
<div><dl class="docutils">
<dt><strong>Framework Quality: Unit-Tests as silent witness</strong></dt>
<dd>Unit-Tests are often overlooked in framework discussions that focus</dd>
</dl>
<p>on features, performance, tools or database abstraction. However
they are a silent witness on how poor or well frameworks are
designed. In this presentation we will look at the testsuites of the
big players in the PHP framework business - Zend Framework,
ezComponents, Symfony and CakePHP - and reveal their hidden secrets.</p>
</div></blockquote>
<p>This talk will make heavy use of the <a class="reference external" href="https://github.com/beberlei/puma/tree">PHP Unittest and Metrics
Aggregator tool</a>, which i haven
written on several times. For both CakePHP and Symfony extensions for
their testtools may have to be written.</p>
<p>I am really excited for my first time being speaker on a conference and
looking forward to see you at IPC.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by beberlei <kontakt@beberlei.de></span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2009/03/10/speaking-about-framework-quality-on-the-ipc-spring-09.html#disqus_thread" data-disqus-identifier="2009/03/10/speaking-about-framework-quality-on-the-ipc-spring-09">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>October 05, 2009</span> 
        </div>
        <div class="section" id="php-codesniffer-for-netbeans-v0-2">
<h1><a href="2009/10/05/php-codesniffer-for-netbeans-v0-2.html">PHP CodeSniffer for Netbeans v0.2</a></h1>
<p>I finally found some time to spend some time on the <a class="reference external" href="http://github.com/beberlei/netbeans-php-enhancements/">PHP CodeSniffer for
Netbeans
plugin</a>.
Previously the plugin used an unnecessary API which restricted the use
to Netbeans 6.7.0 only. This API was removed so that the plugin should
now work with all Netbeans Versions &gt;= 6.7.0.</p>
<p>Additionally when working the previous version would scan every PHP
script on a file per file basis when the all projects or main projects
filters were activated. This rendered made the plugin almost useless. In
the current version scans of filters that contain more than one file are
blocked. That means you will only see Coding Violations when you enable
the “Current File” filter. Using any other filter will just do nothing
and won’t put your Netbeans in permanent hibernation mode (aka useless
mode).</p>
<p>There is also some preference <strong>“phpcs.codingStandard”</strong> using the
<strong>`NbPreferences
API &lt;http://bits.netbeans.org/dev/javadoc/org-openide-util/org/openide/util/NbPreferences.html&gt;`_</strong>
which allows to configure the coding standard. [STRIKEOUT:However this
feature was contributed by <a class="reference external" href="http://manuel-pichler.de/">Manuel
Piechler</a> and I don’t yet understand how I
can manipulate it. Maybe someone knows how (*Looking in Mapis general
direction*)?] By default the Zend Coding Standard is used.</p>
<p><strong>Update:</strong> Coding Standard can be changed by hacking into the config
file .netbeans/6.7/config/Preferences.properties setting
“phpcs.CodingStandard=”. Additionally I fixed several bugs with the
inline highlighting that did not refresh when lines in the file changed.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by beberlei <kontakt@beberlei.de></span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2009/10/05/php-codesniffer-for-netbeans-v0-2.html#disqus_thread" data-disqus-identifier="2009/10/05/php-codesniffer-for-netbeans-v0-2">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>December 19, 2009</span> 
        </div>
        <div class="section" id="trying-a-two-step-pear-phar-approach-to-develop-and-deploy">
<h1><a href="2009/12/19/trying-a-two-step-pear-phar-approach-to-develop-and-deploy.html">Trying a Two Step PEAR/PHAR approach to develop and deploy</a></h1>
<p>With PHP 5.3 the PHAR extension is a pretty powerful concept for all
your deployment needs, however it does not tell the complete story.
Frameworks, Libraries and many different of them are used throughout
applications and in recent times people even began to chery-pick the
best components from each of the frameworks and package them together.
With Pirum being a simple PEAR channel server there is also momentum for
projects to distribute their code via PEAR.</p>
<p>However PEAR is mostly used in the server-wide configuration use-case,
which is not very useful if you plan to distribute your complete
application in one PHAR file. I just recently had the idea for this
scenario, so please bear with me and add all the feedback and comments
you can come up with. I tested this with the ongoing rewrite of my blog
software.</p>
<p>First we’ll add a new user that we develop our application with:</p>
<div class="highlight-python"><pre>sudo useradd -m -g www-data whitewashing
sudo passwd whitewashing
su - whitewashing</pre>
</div>
<p>Now there is the possibility that with this user PHP and PEAR is not in
your $PATH environment, so you might have to add it. In my case on Ubuntu
i also had to switch the console from /bin/sh to /bin/bash for this
user. Then we need to setup our application, I am going to use the Zend
Framework project style here but with a little twist. We will add a
distinction between vendor and project libraries by adding a <em>vendor</em>
directory into the main folder.</p>
<p>But first we create a folder for our application, and create a Zend
Framework project in the subfolder “trunk”, which will be the focus of
our development.</p>
<div class="highlight-python"><pre>whitewashing@desktop:~$ mkdir whitewashing
whitewashing@desktop:~$ zf create project whitewashing/trunk
Creating project at /home/whitewashing/whitewashing/trunk
whitewashing@desktop:~$ mkdir whitewashing/trunk/vendor</pre>
</div>
<p>Now we can configure an Apache virtual host to point to our
/home/whitewashing/whitewashing/public directory, i call this
“whitewashing-dev” add it to my /etc/hosts and can visit the dummy
project page.</p>
<p>We then configure our PEAR installation for the specific application
user and re-configure the bin and php library paths:</p>
<div class="highlight-python"><pre>whitewashing@desktop:~$ pear create-config /home/whitewashing/ .pearrc
whitewashing@desktop:~$ pear config-set php_dir /home/whitewashing/whitewashing/trunk/vendor
whitewashing@desktop:~$ pear config-set bin_dir /home/whitewashing/whitewashing/trunk/bin</pre>
</div>
<p>This configuration assumes that we will install all our stuff into our
development trunk. From there also the PEAR installed libraries might be
copied into branches or tags. PEAR Project tests, configuration and
web-files will still be put by default under $HOME/pear/*. We don’t
need them for our applications.</p>
<p>Now we install all the dependencies our project needs, in this case Zend
Framework, Doctrine 2, HTML Purifier:</p>
<div class="highlight-python"><pre>whitewashing@desktop:~$ pear channel-discover pear.zfcampus.org
whitewashing@desktop:~$ pear install zfcampus/zf-alpha
whitewashing@desktop:~$ pear channel-discover htmlpurifier.org
whitewashing@desktop:~$ pear install hp/HTMLPurifier
whitewashing@desktop:~$ pear channel-discover pear.phpdoctrine.org
whitewashing@desktop:~$ pear install pear.phpdoctrine.org/DoctrineORM-2.0.0</pre>
</div>
<p>Now we have all three of the packages installed in our project folder
<cite>whitewashing/trunk/vendor</cite>, see:</p>
<div class="highlight-python"><pre>whitewashing@desktop:~$ ls -aFl whitewashing/trunk/vendor/
total 680
drwxr-xr-x  7 whitewashing www-data   4096 2009-12-13 14:45 ./
drwxr-xr-x  8 whitewashing www-data   4096 2009-12-13 14:36 ../
drwxr-xr-x  3 whitewashing www-data   4096 2009-12-13 14:43 .channels/
-rw-r--r--  1 whitewashing www-data     57 2009-12-13 14:45 .depdb
-rw-r--r--  1 whitewashing www-data      0 2009-12-13 14:45 .depdblock
drwxr-xr-x  5 whitewashing www-data   4096 2009-12-13 14:45 Doctrine/
-rw-r--r--  1 whitewashing www-data 582208 2009-12-13 14:45 .filemap
drwxr-xr-x 20 whitewashing www-data   4096 2009-12-13 14:39 HTMLPurifier/
-rw-r--r--  1 whitewashing www-data    629 2009-12-13 14:39 HTMLPurifier.autoload.php
-rw-r--r--  1 whitewashing www-data    274 2009-12-13 14:39 HTMLPurifier.auto.php
-rw-r--r--  1 whitewashing www-data    545 2009-12-13 14:39 HTMLPurifier.func.php
-rw-r--r--  1 whitewashing www-data   9299 2009-12-13 14:39 HTMLPurifier.includes.php
-rw-r--r--  1 whitewashing www-data    955 2009-12-13 14:39 HTMLPurifier.kses.php
-rw-r--r--  1 whitewashing www-data   8831 2009-12-13 14:39 HTMLPurifier.php
-rw-r--r--  1 whitewashing www-data  11901 2009-12-13 14:39 HTMLPurifier.safe-includes.php
-rw-r--r--  1 whitewashing www-data      0 2009-12-13 14:45 .lock
drwxr-xr-x  8 whitewashing www-data   4096 2009-12-13 14:43 .registry/
drwxr-xr-x 59 whitewashing www-data   4096 2009-12-13 14:36 Zend/
-rw-r--r--  1 whitewashing www-data  19537 2009-12-13 14:36 zf.php</pre>
</div>
<p>And both Doctrine and ZF registered their binary CLi tools inside the
<cite>whitewashing/trunk/bin/</cite> folder:</p>
<div class="highlight-python"><pre>whitewashing@desktop:~$ ls -aFl bin/
total 20
drwxr-xr-x 2 whitewashing www-data 4096 2009-12-13 14:45 ./
drwxr-xr-x 8 whitewashing www-data 4096 2009-12-13 14:36 ../
-rwxr-xr-x 1 whitewashing www-data   50 2009-12-13 14:45 doctrine*
-rwxr-xr-x 1 whitewashing www-data  169 2009-12-13 14:45 doctrine.php*
-rwxr-xr-x 1 whitewashing www-data 1511 2009-12-13 14:36 zf*</pre>
</div>
<p>We now have the full control over the versions of our dependencies, we
can call “pear upgrade ” whenever we want to update one of the ZF,
Doctrine or HtmlPurifier libraries inside our application.</p>
<p>Now some magic is gonna happen, we start to develop our application and
such which is all not really interesting for this topic. At some point
we want to package it all up into a PHAR file and distribute it. We want
to package our application in one big phar file. We also want to make
sure that the configuration files in
<cite>whitewashing/trunk/application/configs/</cite> are not distributed, but have
to be created on the server and are kept that way. We could write an
installer script for this configuration management.</p>
<p>The reference for PHAR files is the PHP Manual for the Basics and Cal
Evans’ two posts
(<a class="reference external" href="http://blog.calevans.com/2009/07/19/lessons-in-phar/">1</a>,
<a class="reference external" href="http://blog.calevans.com/2009/07/26/packaging-zend-framework-as-a-phar-revisited/">2</a>)
on this topic, aswell as <a class="reference external" href="http://geekmonkey.org/articles/PHP_Archives">a post on
Geekmonkey</a>. Contrary to
most other PHP extensions, PHAR has an extensive documentation, however
its not organized terribly well. Also there are no real use-cases and
scenarios discussed, methods are only looked at in isolation. Cals posts
are very good on understanding how to package up different libraries,
but there is no word on distributing web applications. That is where the
Geekmonkey post comes in to wire it all together.</p>
<p>For a Zend Framework application that should have both a web and a cli
(cronjobs) entry point into the application we need a specific stub file
for the PHAR bootstrapping. A stub is a little PHP script that is
executed whenever your PHAR file is included into your php script. It is
essentially a front-controller for your PHAR application. It also has
mount capabilities that allow to import files or directories from
outside into the PHAR context. This is a powerful feature that is
required to distribute configurable applications like our blog.</p>
<p>This screenshot shows how the application is currently structured in
development mode. In production its structure should look like:</p>
<div class="highlight-python"><pre>whitewashing
|--application
|  |--configs
|     |-- my application config files are all here...
|--bin
|  |--whitewashing.php
|--public
|  |--index.php
|  |--.htaccess
|--whitewashing.phar</pre>
</div>
<p>The whitewashing.php and index.php files are the application entry
points that only include the phar file and trigger the application
bootstrapping that will be included in the Stub file. They both look
like:</p>
<div class="highlight-python"><pre>&lt;?php
define('EXTERNAL_APPLICATION_ROOT', __DIR__.&quot;/../&quot;);
include EXTERNAL_APPLICATION_ROOT.&quot;/whitewashing.phar&quot;;</pre>
</div>
<p>Including a PHAR file essentially has two consequences:</p>
<ul class="simple">
<li>The PHAR path will be added to your include path.</li>
<li>The stub file will be executed.</li>
</ul>
<p>Our application stub looks like this:</p>
<div class="highlight-python"><pre>&lt;?php

if(defined('EXTERNAL_APPLICATION_ROOT')) {
    // Mount the external application/configs directory as config if it exists.
    if (file_exists(EXTERNAL_APPLICATION_ROOT.&quot;/application/configs&quot;)) {
        Phar::mount(&quot;application/configs&quot;, EXTERNAL_APPLICATION_ROOT.&quot;/application/configs&quot;);
    }
}

/** Zend_Loader_Autoloader */
require_once 'Zend/Loader/Autoloader.php';
$autoloader = Zend_Loader_Autoloader::getInstance();

if (php_sapi_name() == &quot;cli&quot;) {
    require_once 'bin/whitewashing.php';
} else {
    require_once 'public/index.php';
}

__HALT_COMPILER();</pre>
</div>
<p>The first bit of the stub mounts the external application configs
directory into the stub and hides possible directories that are present
at this location in the PHAR file. This allows us to distribute our
application with a default configuration, but allows any user to replace
the configuration files to fit the application to his need.</p>
<p>The second bit loads Zend Framework Autoloader that is required by the
bootstrapping mechanism. The third bit decides whether this request is
executed from the CLI- or the Web-Entry point of the application. The
fourth bit, <tt class="docutils literal"><span class="pre">__HALT_COMPILER();</span></tt> is a technically required call inside
your stub-file.</p>
<p>Now that we have a stub-file for our application, we can package it and
distribute it. I am using a modified version of Cal Evans example for
this. I have extracted his directory traversal to find all the relevant
into a re-usable FilterIterator implementation. I <a class="reference external" href="https://gist.github.com/3b20264b857dbdabf526">pasted my package.php
a Gist</a> on Github. Now
this should probably be put into the build context of your application,
possibly as a phing or ant task or something alike.</p>
<p>Now what this build process does not manage is the creation of the
application entry point php and .htaccess files, but since they won’t
ever change its easy to add them to the build directory for now. An even
more sophisticated version of the build script would lead to the
creation of an additional tar.gz of the complete application folder. Our
deployment process would then be as easy as:</p>
<ul class="simple">
<li>If the application is not installed yet, unpack the tarball into its
location.</li>
<li>If the application should be updated, just replace the PHAR file.</li>
</ul>
<p>If you need the ability to go back to any version of your application
you could make use of symlinks.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by beberlei <kontakt@beberlei.de></span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2009/12/19/trying-a-two-step-pear-phar-approach-to-develop-and-deploy.html#disqus_thread" data-disqus-identifier="2009/12/19/trying-a-two-step-pear-phar-approach-to-develop-and-deploy">Leave a comment</a>
        </div>
    </div>
    
    <div class="related">
        <ul>
            <li>
                 &laquo; <a href="page2.html">Newer</a>
            </li>
            <li class="right">
                <a href="page4.html">Older</a> &raquo; 
            </li>
        </ul>
    </div>
    <div class="archive_link">
        <a href="archive.html"> &mdash; Blog Archive &mdash; </a>
    </div>


            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'whitewashing';
                var disqus_url = 'http://www.whitewashing.de/page3.html';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>         
        </div>
      </div>
    </div>

    <div class="span-24 last">
        
          
            <div class="yui-b" id="sidebar">
              
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">

<div class="widget">
    <h3>Recent Posts</h3>
    <ul>
        <li class="recent_post">
            <a href="2012/10/22/a_tent_io_app__zelten_bookmarks.html">A tent.io app: Zelten Bookmarks</a>
        </li>
        <li class="recent_post">
            <a href="2012/09/04/using_assertions_for_validation.html">Using Assertions for validation</a>
        </li>
        <li class="recent_post">
            <a href="2012/08/26/symfony__monolog_and_different_log_types.html">Symfony, Monolog and different log types</a>
        </li>
        <li class="recent_post">
            <a href="2012/08/26/froscon_2012.html">FrOSCon 2012</a>
        </li>
        <li class="recent_post">
            <a href="2012/08/25/decoupling_applications_with_domain_events.html">Decoupling applications with Domains Events</a>
        </li>
        <li class="recent_post">
            <a href="2012/08/22/building_an_object_model__no_setters_allowed.html">Building an Object Model: No setters allowed</a>
        </li>
        <li class="recent_post">
            <a href="2012/08/18/oop_business_applications__command_query_responsibility_seggregation.html">OOP Business Applications: Command-Query-Responsibility-Segregation (CQRS)</a>
        </li>
        <li class="recent_post">
            <a href="2012/08/16/oop_business_applications__data__context__interaction.html">OOP Business Applications: Data, Context, Interaction</a>
        </li>
        <li class="recent_post">
            <a href="2012/08/13/oop_business_applications_entity_boundary_interactor.html">OOP Business Applications: Entity, Boundary, Interactor</a>
        </li>
        <li class="recent_post">
            <a href="2012/08/11/oop_business_applications__trying_to_escape_the_mess.html">OOP Business Applications: Trying to escape the mess</a>
        </li>
    </ul>
</div>

        </div>
      </div>
            </div> 
          
        
    </div>
</div>

      <div class="clearer"></div>
    </div>
<div class="container">
    <div class="span-24 content">
        <div class="footer">
            &copy; Copyright 2008-2012, Benjamin Eberlei.
            Powered by <a href="http://www.tinkerer.me/">Tinkerer</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.

        <script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script>
        </div>
    </div>
</div>

  </body>
</html>