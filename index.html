





<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Home &mdash; Whitewashing</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/disqus.js"></script>
    <script type="text/javascript" src="_static/ga.js"></script>
    <link rel="shortcut icon" href="_static/tinkerer.ico"/>
    
    <link rel="top" title="Whitewashing" href="#" />
    <link rel="next" title="Older" href="page1.html" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /> 
  </head>
  <body>
<div class="container">
    <div id="header" class="span-8">
        <a href="#"><img src="_static/logo.jpg" alt="Whitewashing.de" /></a>
    </div>
    <div class="span-11" id="about">
        <p>
            Whitewashing is the blog of Benjamin Eberlei and covers topics in software-development and object-oriented-design. Benjamin works
            for <a href="http://qafoo.com/" target="_blank">Qafoo</a> and you can book him for consulting and trainings.
        </p>
    </div>
    <div class="span-5 last">
        <p class="buttons" style="text-align: right">
            <a href="https://twitter.com/beberlei"><img src="_static/twitter-logo.png" alt="Follow me on twitter" height="50" /></a>
            <a href="http://www.whitewashing.de/rss.xml"><img src="_static/rss2.png" alt="Subscribe to RSS" height="50" /></a>
            <a href="https://github.com/beberlei"><img src="_static/github-logo.png" alt="My Github Profile" height="50" /></a>
        </p>
    </div>
</div>



    <div class="document">
<div class="container">
    
    <div class="span-24 content">
      <div>
        <div>
          <div id="index">
            
            
    
    <div class="related">
        <ul>
            <li class="right">
                <a href="page1.html">Older</a> &raquo; 
            </li>
        </ul>
    </div>
        
        <div class="timestamp postmeta">
            <span>February 19, 2013</span> 
        </div>
        <div class="section" id="extending-symfony2-paramconverter">
<h1><a href="2013/02/19/extending_symfony2__paramconverter.html">Extending Symfony2: ParamConverter</a></h1>
<p>Symfony2 is an extremly extendable framework, everything is extendable or
overwritable through the Dependency Injection Container. The problem developers
face is knowing about the extension points and when to use them.  If you don’t
know the extension points, your Symfony application will end up with code
duplication, too much inheritance and very little unit-testable code.</p>
<p>This blog post will be the first in a series, describing Symfony2 extension
points that help you achieve clean and duplicateless code. In my experience,
using Symfony extension points to avoid code duplication helps you avoid
writing thousands of lines of code in your controllers.</p>
<div class="section" id="the-problem-duplicate-finder-logic">
<h2>The problem: Duplicate finder logic</h2>
<p>Inside controllers you can easily end with lots of duplication using the same
general finder logic again in several actions. Take this following example:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">UserController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">showAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT u, d, a</span>
<span class="s2">                  FROM MyBundle\Entity\User u</span>
<span class="s2">                  JOIN u.details d</span>
<span class="s2">                  JOIN u.addresses a</span>
<span class="s2">                  WHERE u.id = ?1&quot;</span><span class="p">;</span>

        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'doctrine.orm.default_entity_manager'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">getSingleResult</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">NotFoundHttpException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s1">'user'</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If we need this block of code in several actions of different controllers, we
will end up with duplication that has to be eliminated.</p>
</div>
<div class="section" id="the-quick-and-dirty-solution">
<h2>The Quick and Dirty Solution</h2>
<p>One way of resolving the duplication appearing in this case, is moving the
finder + not found logic into a common controller base class or into a trait.
But this leaves us with a helper method buried in the code and a static
dependency to a base class or a trait that we want to avoid.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">AbstractController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">findUser</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT u, d, a</span>
<span class="s2">                  FROM MyBundle\Entity\User u</span>
<span class="s2">                  JOIN u.details d</span>
<span class="s2">                  JOIN u.addresses a</span>
<span class="s2">                  WHERE u.id = ?1&quot;</span><span class="p">;</span>

        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'doctrine.orm.default_entity_manager'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">getSingleResult</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">NotFoundHttpException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$user</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There are two problems with this sort of refactoring:</p>
<ol class="arabic simple">
<li>We are using inheritance for code-reuse.</li>
<li>We hide the <tt class="docutils literal"><span class="pre">findUser</span></tt> behavior in an abstract class and make it hard to test.</li>
</ol>
</div>
<div class="section" id="the-preferred-solution">
<h2>The Preferred Solution</h2>
<p>The <a class="reference external" href="http://symfony.com/doc/current/bundles/SensioFrameworkExtraBundle/annotations/converters.html">SensioFrameworkExtraBundle</a>
offers an extension hook called <strong>Parameter Converters</strong> to transform Request
attributes to objects directly for controller method arguments. They hook into
the <tt class="docutils literal"><span class="pre">kernel.controller</span></tt> event that you can use yourself to achieve the same
goal.</p>
<p>Lets see how the action will look like after our refactoring:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">UserController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">showAction</span><span class="p">(</span><span class="nx">User</span> <span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s1">'user'</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Very concise and easy to read. The param converter doing the heavy lifting
looks like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\Request\ParamConverter</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Sensio\Bundle\FrameworkExtraBundle\Configuration\ConfigurationInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Sensio\Bundle\FrameworkExtraBundle\Request\ParamConverter\ParamConverterInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpKernel\Exception\NotFoundHttpException</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityManager</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserParamConverter</span> <span class="k">implements</span> <span class="nx">ParamConverter</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$entityManager</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">EntityManager</span> <span class="nv">$entityManager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">apply</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">ConfigurationInterface</span> <span class="nv">$configuration</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>

        <span class="nv">$dql</span> <span class="o">=</span> <span class="s2">&quot;SELECT u, d, a</span>
<span class="s2">                  FROM MyBundle\Entity\User u</span>
<span class="s2">                  JOIN u.details d</span>
<span class="s2">                  JOIN u.addresses a</span>
<span class="s2">                  WHERE u.id = ?1&quot;</span><span class="p">;</span>

        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'doctrine.orm.default_entity_manager'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$dql</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">getSingleResult</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">NotFoundHttpException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nv">$param</span> <span class="o">=</span> <span class="nv">$configuration</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">();</span>
        <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">(</span><span class="nv">$param</span><span class="p">,</span> <span class="nv">$user</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">supports</span><span class="p">(</span><span class="nx">ConfigurationInterface</span> <span class="nv">$configuration</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;MyProject\Entity\User&quot;</span> <span class="o">===</span> <span class="nv">$configuration</span><span class="o">-&gt;</span><span class="na">getClass</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we only need to register this class in the dependency injection container:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;service</span> <span class="na">id=</span><span class="s">&quot;my_project.user_param_converter&quot;</span>
      <span class="na">class=</span><span class="s">&quot;MyProject\Request\ParamConverter\UserParamConverter&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">&quot;service&quot;</span> <span class="na">id=</span><span class="s">&quot;doctrine.orm.default_entity_manager&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;tag</span> <span class="na">name=</span><span class="s">&quot;request.param_converter&quot;</span> <span class="na">converter=</span><span class="s">&quot;user&quot;</span> <span class="na">priority=</span><span class="s">&quot;10&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/service&gt;</span>
</pre></div>
</div>
<p>With the priority configuration the <tt class="docutils literal"><span class="pre">User</span></tt> entity is now alway handled
by our custom param converter and not by the default Doctrine converter.</p>
<p>In a next step, we should extract the query logic from the ParamConverter
into a custom Doctrine entity repository. But that is a task for another blog
post in this series.</p>
</div>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        <div class="categories">
            <span>
                Filed under:
                
                    <a href="categories/symfony2.html">Symfony2</a>
                
            </span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                
                    <a href="tags/symfony2_extendingsymfony2.html">Symfony2 ExtendingSymfony2</a>
                
            </span>
        </div>
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2013/02/19/extending_symfony2__paramconverter.html#disqus_thread" data-disqus-identifier="2013/02/19/extending_symfony2__paramconverter">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>February 05, 2013</span> 
        </div>
        <div class="section" id="avoid-implementing-business-rules-with-annotations">
<h1><a href="2013/02/05/avoid_implementing_business_rules_with_annotations.html">Avoid implementing business rules with Annotations</a></h1>
<p>In January I was participating at the awesome <a class="reference external" href="http://conference.phpbenelux.eu/2013/schedule/">PHP Benelux 2013</a> conference and attended
<a class="reference external" href="http://www.rafaeldohms.com.br/">Raphael Dohms</a> talk on “PHP Annotations -
They exist!”. It was a very good talk about the history, current state and
actual implementations for Annotations in PHP.</p>
<p>At the end of the talk there was an important question from one person in the
audiance about how to test code that is using annotations to drive the business
rules. I try to answer the question in this blog post.</p>
<p>Lets start by the beginning and define annotations. Annotations are metadata to
code blocks. Comparable to INI, XML or YAML they provide a way to load
configuration. In contrast to the other configuration mechanisms however,
annotations are right next to PHP code they configure. They allow you to
configure classes, properties, methods in context without having to move around
in several of configuration files.</p>
<p>The Doctrine Annotations library has spawned several new libraries that allow
to configuration through annotations. Should we just use them, because they are
so convenient?</p>
<p>No! In my opinion it is important to differentiate between different use-cases
of annotations. Take a look at Doctrine ORM Mapping or Raphaels DMS Filter library.
Using their annotations looks like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">DMS\Filter\Rules</span> <span class="k">as</span> <span class="nx">Filter</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity</span>
<span class="sd"> * @ORM\Table(name=&quot;users&quot;)</span>
<span class="sd"> **/</span>
<span class="k">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Id @ORM\GeneratedValue @ORM\Column(type=&quot;integer&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">private</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;string&quot;)</span>
<span class="sd">     * @Filter\Trim()</span>
<span class="sd">     **/</span>
    <span class="k">private</span> <span class="nv">$email</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Both libraries solve problems of the infrastructure layer and not of the
business domain. Both libraries could probably also be configurable through
PHP code, XML and YAML and this would be completly fine.</p>
<p>The use of annotations in this case is just a substitute for XML, INI or YAML
configuration files, allowing your business model to integrate into infrastructure
libraries.</p>
<p>The same holds for the Serialization-, WSDL- or Routing configuration using
annotations.</p>
<div class="section" id="problematic-use-cases">
<h2>Problematic Use-Cases</h2>
<p>There are use-cases when I am careful about the use of annotations (any kind
of configuration actually): When I am configuring how my business
objects works. The following real-world use-cases come to mind:</p>
<ul class="simple">
<li>Validation</li>
<li>Aspects</li>
<li>Dependency Injection</li>
</ul>
<p>When libraries allow you to configure how your business objects work based on
annotations, coupled to the respective libraries way of doing things, problems
are going to appear. Depending on the implementation this can end up very
badly, with serious coupling of the library towards your business objects.</p>
<div class="section" id="validation">
<h3>Validation</h3>
<p>Symfony Validator allows you to add assertions for validation rules on the
properties or methods of your business models.</p>
<p>If you think about it, validation is a cross-cutting concern. It is part of the
infastructure for simple validation rules like checking if the user input data
is valid, but it can also be used for business logic of your domain.</p>
<p>See this code example:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Validator\Constraints</span> <span class="k">as</span> <span class="nx">Assert</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">MyProject\Validator\Constraints\EmailBlacklist</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Assert\NotBlank</span>
<span class="sd">     * @Assert\Email</span>
<span class="sd">     * @EmailBlacklist</span>
<span class="sd">     **/</span>
    <span class="k">private</span> <span class="nv">$email</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We added three validation rules here, two from the Symfony core validating the
email syntax and not blank, another one from my own project, validating the
email aginst some blacklist.</p>
<p>Now in Symfony you can use this code either directly through the Validation
service or indirectly through the Form component:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$validator</span> <span class="o">=</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'validator'</span><span class="p">);</span>

<span class="nv">$user</span>          <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
<span class="nv">$violationList</span> <span class="o">=</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
</pre></div>
</div>
<p>This sort of tangling of critical business logic to framework services is a
problem. The reason for this is that you want to be able to unit-test your
business logic. A deep integration of your business logic into the Symfony
Validation component will prevent you from actually doing this.</p>
<p>To test this validation constraint, you need to:</p>
<ul class="simple">
<li>Call the validator service with a user object and a blacklisted email</li>
<li>Call the validator service with a user object and a non-blacklisted email</li>
</ul>
<p>In addition to testing the actual email blacklist validation, they verify
annotation parsing and the full Symfony Validator stack. In general these tests
are slow and I know this from experience, not following my own advice.</p>
<p>Instead you should write a completely independent E-Mail Blacklist Service:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\Validator</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">EmailBlacklistService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">isBlacklisted</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span> <span class="c1">// logic here</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This service can be unit-tested and is part of your actual business domain,
independent of Symfony. You can now integrate this into a Symfony Validator:</p>
<blockquote>
<div><p>&lt;?php</p>
<p>namespace MyProjectValidatorConstraints;</p>
<p>use SymfonyComponentValidatorConstraint;
use MyProjectValidatorEmailBlacklistService;</p>
<dl class="docutils">
<dt>/**</dt>
<dd><ul class="first simple">
<li>@Annotation</li>
</ul>
<p class="last"><a href="#id1"><span class="problematic" id="id2">**</span></a>/</p>
</dd>
</dl>
<p>class EmailBlacklist extends Constraint
{</p>
<blockquote>
<div>public $message = ‘Your email %email% is on our blacklist.’;</div></blockquote>
<p>}</p>
<p>class EmailBlacklistValidator
{</p>
<blockquote>
<div><p>private $blacklist;</p>
<p>public function __construct(EmailBlacklistService $blacklist)
{</p>
<blockquote>
<div>$this-&gt;blacklist = $blacklist;</div></blockquote>
<p>}</p>
<p>public function validate($value, Constraint $constraint)
{</p>
<blockquote>
<div><dl class="docutils">
<dt>if ($this-&gt;blacklist-&gt;isBlacklisted($value)) {</dt>
<dd><dl class="first docutils">
<dt>$this-&gt;context-&gt;addViolation(</dt>
<dd>$constraint-&gt;message,
array(‘%email%’ =&gt; $value)</dd>
</dl>
<p class="last">);</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>Now actually what we can do is write a unit-test for this Symfony validator
using mock objects. We can add a single functional tests to actually verify
the configuration is present on the <tt class="docutils literal"><span class="pre">User$email</span></tt> property, but we don’t
actually need to test the validation logic through the full stack.</p>
<p>Inside our business model you can reuse the Blacklist Service without having to
depend on Symfony code. So instead of injecting the full validator service,
you can just inject the much more explicit blacklist service.</p>
<p>Validation libraries are a tricky problem when combined with validation rules
from your business domain. Be careful not to depend on them too much with
your business logic and keep it seperate.</p>
</div>
<div class="section" id="dependency-injection">
<h3>Dependency Injection</h3>
<p>Using Annotations for Dependency Injection is not necessarily bad,
however the way its implemented in some frameworks may lead to
code that is unusable without the Dependency Injection container.</p>
<p>FLOW3 allows to inject dependencies into properties of instances:</p>
<blockquote>
<div><p>class BlogService
{</p>
<blockquote>
<div><dl class="docutils">
<dt>/**</dt>
<dd><ul class="first simple">
<li>@Inject</li>
</ul>
<p class="last"><a href="#id3"><span class="problematic" id="id4">**</span></a>/</p>
</dd>
</dl>
<p>private $blogRepository;</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>This even works when you are instantiating the object yourself using <tt class="docutils literal"><span class="pre">new</span></tt>.
So inside FLOW3, the call to <tt class="docutils literal"><span class="pre">new</span> <span class="pre">BlogService</span></tt> automatically injects the
repository.</p>
<p>The problem here is easy to spot. If you use framework supported Dependency
Injection with Reflection, then you don’t need to write constructors or setters
anymore that actually asign the repository. This prevents you from actually
testing the code, because the classes are not easily instantiatable in a
Unit-Test anymore. Additionally you might rely on the automagic injection
in your code, so much that it is not executable without the Injection
framework being present in your unit-tests.</p>
<p>You can of course start providing constructors or setters, but this feature
still affects your control flow in production, using reflection instead
of the “expected” control flow.</p>
</div>
<div class="section" id="aspects">
<h3>Aspects</h3>
<p>In FLOW3 Annotations are used to change the control flow of the applications.
As a developer you can introduce code and make it execute around arbitrary
other code. The way its implemented with code generation you can never
actually unit-test this yourself, because any test-setup requires the Aspect
Engine to run.</p>
<p>This is obviously a huge change of control flow, configured through
annotations. Additionally there is the code generation involved. I am very
skeptical about large scale usage of this kind of feature if it affects
the way your business logic works.</p>
<p>Testing this kind of feature is obviously not possible without the
AOP framework. This effectively means that its impossible to unit-test
your domain objects.</p>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>There is a difference between using Annotations for configuration of
infrastructure services and business model interaction. The first one is
perfectly fine, its replacable by any other sort of configuration or explicit
programmatic code and doesn’t hinder you writing unit-tests for your business
model. The second one makes it hard to actually do unit-testing without using
the libraries that perform the actual operations.</p>
</div>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        <div class="categories">
            <span>
                Filed under:
                
                    <a href="categories/php.html">PHP</a>
                
            </span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                
                    <a href="tags/php.html">PHP</a>
                
            </span>
        </div>
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2013/02/05/avoid_implementing_business_rules_with_annotations.html#disqus_thread" data-disqus-identifier="2013/02/05/avoid_implementing_business_rules_with_annotations">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>February 04, 2013</span> 
        </div>
        <div class="section" id="doctrine-and-solid">
<h1><a href="2013/02/04/doctrine_and_solid.html">Doctrine and SOLID</a></h1>
<p>I often get asked how you can use <a class="reference external" href="http://www.doctrine-project.org">Doctrine2</a> and implement <a class="reference external" href="http://en.wikipedia.org/wiki/SOLID_(object-oriented_design)">the SOLID principles</a> at the same
time. It bugs me having to reply: It is not really possible.  Because Doctrine2
does not support value-objects (or embedded-objects), it is very hard to pull
the <a class="reference external" href="http://en.wikipedia.org/wiki/Single_responsibility_principle">Single Responsibility Principle</a> off.</p>
<p>These problems are related to the inability to share behavioral code through
aggregation and the complexity of state transformations. Combining both, your
average entity with 5-15 fields can end up with hundreds or thousands lines of
code. The solutions to both problems boil down to <a class="reference external" href="http://www.jbrains.ca/permalink/the-four-elements-of-simple-design">minimizing duplication and
maximizing clarity</a>.</p>
<div class="section" id="extracting-value-objects-minimize-duplication">
<h2>Extracting Value Objects: Minimize Duplication</h2>
<p>Entity classes responsibility are the state transformations of their internal
fields.  This can simply be done by using setter methods or <a class="reference external" href="http://whitewashing.de/2012/08/22/building_an_object_model__no_setters_allowed.html">when avoiding
setters</a>,
with use-case driven methods.  These state transformations can be part of
different responsibilities, specifically when properties belong to different
groups of concepts.</p>
<p>Take a very simple entity that contains updated/created at logic:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity</span>
<span class="sd"> * @ORM\HasLifecycleCallbacks</span>
<span class="sd"> **/</span>
<span class="k">class</span> <span class="nc">Person</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;datetime&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">private</span> <span class="nv">$createdAt</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;datetime&quot;)</span>
<span class="sd">     **/</span>
    <span class="k">private</span> <span class="nv">$updatedAt</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createdAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;now&quot;</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">updatedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;now&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\PreUpdate</span>
<span class="sd">     **/</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">updatedAt</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">updatedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;now&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you want to duplicate this logic to another second entity, then in Doctrine
the solution for this is using traits. <a class="reference external" href="http://kore-nordmann.de/blog.html">Kore</a> will dismiss this solution, because
traits create a hard dependency. Even if we accept the static dependency,
traits are not perfect even for this very simple example, because its very
likely that you cannot override the constructor of every entity.</p>
<p>The solution is to extract a value object <tt class="docutils literal"><span class="pre">Timestamped</span></tt> that contains
all the logic:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Timestamped</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$createdAt</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$updatedAt</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createdAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;now&quot;</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">updatedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;now&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">updatedAt</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">updatedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">&quot;now&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Person</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$timestamped</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">timestamped</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Timestamped</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>See how all the code could be moved into <tt class="docutils literal"><span class="pre">Timestamped</span></tt> and is now reusable
in other entities.</p>
<p>Doctrine has no support for embedded objects, which is very sad. I am working
very hard to get this feature into Doctrine as soon as possible. You can use
the “object” type as a workaround and <tt class="docutils literal"><span class="pre">serialize()</span></tt> the value object into
the database. However this is beyond ugly in my opinion.</p>
</div>
<div class="section" id="extract-method-objects-maximizing-clarity">
<h2>Extract Method Objects: Maximizing clarity</h2>
<p>Once you have identified groups of fields that are modified, then the
complexity of the state transformations can attract lots of code.</p>
<p>Take an <tt class="docutils literal"><span class="pre">Order</span></tt> object that has a method for calculating the shipping costs,
depending all the order items and products.
To separate calculations from state transformations you can extract
method objects instead of inlining the code into the <tt class="docutils literal"><span class="pre">Order</span></tt> object.</p>
<p>For this kind of extraction I create a folder <tt class="docutils literal"><span class="pre">Order</span></tt> and put all
the extracted method objects in the <tt class="docutils literal"><span class="pre">Order</span></tt> subnamespace.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\Entity</span> <span class="p">{</span>

    <span class="k">class</span> <span class="nc">Order</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">function</span> <span class="nf">calculateShippingCosts</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nv">$calculator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ShippingCostCalculator</span><span class="p">();</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shippingCosts</span> <span class="o">=</span> <span class="nv">$calculator</span><span class="o">-&gt;</span><span class="na">calculate</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">namespace</span> <span class="nx">MyProject\Entity\Order</span> <span class="p">{</span>

    <span class="k">class</span> <span class="nc">ShippingCostCalculator</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">function</span> <span class="nf">calculate</span><span class="p">(</span><span class="nx">Order</span> <span class="nv">$order</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>From this step its easy to make the code reusable by passing the shipping cost
calculator:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Order</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">calculateShippingCosts</span><span class="p">(</span><span class="nx">ShippingCostCalculator</span> <span class="nv">$calculator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shippingCosts</span> <span class="o">=</span> <span class="nv">$calculator</span><span class="o">-&gt;</span><span class="na">calculate</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Another benefit is that you can test the shipping cost calculator directly in a
unit-test and avoid checking for the correctness indirectly through a getter
method for the shipping costs.</p>
<p>Extracting every method of an entity into a method object is obviously
overkill. You should exercise caution and common sense when performing this
refactoring.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Not all the techniques to implement SOLID code can be exploited when using Doctrine
for technical reasons. In the future I hope to support value objects in
Doctrine to make this possible.</p>
</div>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        <div class="categories">
            <span>
                Filed under:
                
                    <a href="categories/php.html">PHP</a>
                
            </span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                
                    <a href="tags/php.html">PHP</a>
                
            </span>
        </div>
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2013/02/04/doctrine_and_solid.html#disqus_thread" data-disqus-identifier="2013/02/04/doctrine_and_solid">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>November 19, 2012</span> 
        </div>
        <div class="section" id="composer-and-azure-websites-git-deployment">
<h1><a href="2012/11/19/composer_and_azure_websites_git_deployment.html">Composer and Azure Websites Git Deployment</a></h1>
<p>Continuing my series on PHP PaaS Clouds (<a class="reference external" href="http://fortrabbit.com/">Fortrabbit</a>), I turn to Microsoft Azure today. After some
research I found out Azure supports post deployment hooks to run
Composer and allows you to configure environment variables from the Management
console.</p>
<p>Microsoft launched <a class="reference external" href="https://www.windowsazure.com/en-us/home/scenarios/web-sites/">Azure Websites</a> in June this
year.  It is a platform as a service solution where you can deploy your
websites via FTP or Git. With Azure Websites you can avoid having to deal with
the complex deployment automation that is necessary for <a class="reference external" href="https://www.windowsazure.com/en-us/home/features/cloud-services/">Azure Hosted Cloud
Services</a>.
As long as your website only requires an SQLServer, MySQL or external APIs you
can actually achieve quite a lot already.</p>
<p>For a <a class="reference external" href="http://www.symfony.com">Symfony2</a>, <a class="reference external" href="http://www.silex-project.org">Silex</a> or any other modern project however you want
<a class="reference external" href="http://www.getcomposer.org">Composer</a> support during the deployment as
long as failures with Composer don’t break your site.</p>
<p>It turns out that Azure Websites - to support other platforms that require
compiling - actually has an extremely robust deployment system (as far as I
understood its internals). The Git repository is separated from the actual code
that is served from the webserver and a number of old checkouts is kept to
allow rollbacks through the Web interface. Once a Git push was recognized,
Azure websites will execute a build step, and then copy all the files over to a
directory with the name of the Git SHA hash. This directory is then symlinked
to the document root.</p>
<p>If Composer fails during this step, the website will still be served from the
currently running version and you don’t have to face unexpected downtime.</p>
<p>To actually run Composer as a post-deployment tool you have to do some manual
work. Create a <tt class="docutils literal"><span class="pre">.deployment</span></tt> file in your project root folder:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[config]</span>
<span class="na">command</span> <span class="o">=</span> <span class="s">&quot;D:\Program Files (x86)\PHP\v5.3\php.exe&quot; build_azure.php</span>
</pre></div>
</div>
<p>If you are using PHP 5.4, then you probably have to change the command version
name to “v5.4”, but I haven’t tested this.</p>
<p>Then you need to create the <tt class="docutils literal"><span class="pre">build_azure.php</span></tt> file that is referenced in the
deployment command. The actual implementation is up to you, my version is
the most simple one:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="s2">&quot;composer.phar&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$url</span> <span class="o">=</span> <span class="s1">'https://getcomposer.org/composer.phar'</span><span class="p">;</span>
    <span class="nb">file_put_contents</span><span class="p">(</span><span class="s2">&quot;composer.phar&quot;</span><span class="p">,</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$url</span><span class="p">));</span>
<span class="p">}</span>

<span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'argv'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;update&quot;</span><span class="p">;</span>
<span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'argv'</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;--prefer-dist&quot;</span><span class="p">;</span>
<span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'argv'</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-v&quot;</span><span class="p">;</span>
<span class="k">require</span> <span class="s2">&quot;composer.phar&quot;</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This currently only works with a Composer version, where
<a class="reference external" href="https://github.com/composer/composer/pull/1341">PR-1341</a> is applied.
You can check out <a class="reference external" href="https://github.com/beberlei/composer/tree/GH-1339">my Composer fork</a> and run
<tt class="docutils literal"><span class="pre">./bin/compile</span></tt> to generate a composer.phar that works.</p>
</div>
<p>Instead of using this approach, you could ship <tt class="docutils literal"><span class="pre">composer.phar</span></tt> with your repository for example.
You can of course execute additional steps in the <tt class="docutils literal"><span class="pre">build_azure.php</span></tt>, for example warmup caches.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        <div class="categories">
            <span>
                Filed under:
                
                    <a href="categories/php.html">PHP</a>
                
            </span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                
                    <a href="tags/azure.html">Azure</a>
                
            </span>
        </div>
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2012/11/19/composer_and_azure_websites_git_deployment.html#disqus_thread" data-disqus-identifier="2012/11/19/composer_and_azure_websites_git_deployment">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>October 27, 2012</span> 
        </div>
        <div class="section" id="babysteps-with-fortrabbit-php-cloud">
<h1><a href="2012/10/27/babysteps_with_fortrabbit_php_cloud.html">Babysteps with Fortrabbit PHP Cloud</a></h1>
<p>I wanted to host a simple application to play around with the <a class="reference external" href="https://tent.io">Tent Protocol</a> (see <a class="reference external" href="http://whitewashing.de/2012/10/22/a_tent_io_app__zelten_bookmarks.html">my last blogpost</a>), so
I checked through some of the PHP Cloud providers again for the fun of it. One
requirement was to deploy from Git and update dependencies from Composer. I
found a new provider that i haven’t heard of before, <a class="reference external" href="http://www.fortrabbit.com/">Fortrabbit</a> that supports this so I had to check it out.
It has some more features that I really dig:</p>
<p>Fortrabbit provides you with a Git url where you can push your repository.
It is directly deployed during the push operation. You can trigger composer
updates by having a special syntax in the commit message. The push
output informs you about all the steps performed during deployment.</p>
<p>Additionally you can configure environment variables in the web-administration
interface that are available in the application through <tt class="docutils literal"><span class="pre">$_SERVER</span></tt>. You
can easily use them to configure your application, if its hosted in a public
repository. Great to share sample applications on Github and host them from
there.</p>
<p>You get SSH access to the machines, where you can take a look at the apache
and php error log files. You have vim available. Quite cool and very helpful
for any kind of debugging necessary. Deployments overwrite every change you
make, so its still a save environment.</p>
<p>The composer support allows for post install scripts, which is cool to perform
all sorts of cache warmup and other deployment tasks.</p>
<p>You can host one application for free, however they shutdown after 48 hours if
you don’t regularly click on a reset button. Its definitely enough to get small
prototypes up and running. From there you can upgrade in many small steps from
small plans (10€/month) to bigger ones (80€/month).</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2012/10/27/babysteps_with_fortrabbit_php_cloud.html#disqus_thread" data-disqus-identifier="2012/10/27/babysteps_with_fortrabbit_php_cloud">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>October 22, 2012</span> 
        </div>
        <div class="section" id="a-tent-io-app-zelten-bookmarks">
<h1><a href="2012/10/22/a_tent_io_app__zelten_bookmarks.html">A tent.io app: Zelten Bookmarks</a></h1>
<p>Over the weekend I built a <a class="reference external" href="http://zelten.eu1.frbit.net">very simple bookmarking application</a> for <a class="reference external" href="http://tent.io">tent.io</a>. I wanted to try the tent functionality to create
arbitrary entities of data using something as simple as a “Bookmark”.</p>
<p>The application retrieves and stores bookmarks on your own tent-server, nothing
is kept on the applications server and as a user you keep full control over
your content (bookmarks).</p>
<p>The <a class="reference external" href="https://github.com/beberlei/zelten-bookmarks">code for the application</a>
is on Github, as well as the <a class="reference external" href="https://github.com/beberlei/TentPHP">TentPHP library</a> I have written to support the protocol.
The application is using PHP, the Silex microframework and MySQL.</p>
<div class="section" id="so-what-is-tent-and-why-bother">
<h2>So what is Tent and why bother?</h2>
<p>About two month ago a new distributed social networking protocol was launched called
<a class="reference external" href="http://tent.io">Tent.io</a>. It works over HTTP using JSON and distributes data
using webhooks. This happened in the shadow of <a class="reference external" href="http://www.app.net">app.net</a>
funding, just two weeks after they collected over 500k USD. Tent.io got lots of
attention but not as much as app.net sadly. Its distributed nature however is
much more suited to achieving true independence of large companies and true privacy
for the users though. Compared to Diaspora it has the benefit of being a protocol, not
an application first.</p>
<p>Now two month later, there are <a class="reference external" href="https://github.com/tent">reference implementations</a>
for Server, Client and a Twitter like Status application. You can use <a class="reference external" href="http://tent.is">Tent.is</a> to create a free or payed tent account including access to
the status application or setup your own tentd server on Heroku.</p>
<p>As a user I can connect any application to the tent server I have registered
with and control the visibility and sharing policies. Content can be private,
public or visible to certain groups only. A Tent server then makes sure to
distribute content to the appropriate subscribers.</p>
<p>In this early state of the protocol it makes sense to register on the central
tent.is service, however when the server gets more stable or alternative
server implementations popup its easy to move all your data off tent.is to your
own server. One feature that will hit tent.is soonish is registration of domain
records. That will be the first step to your own tent server, I am eagerly
waiting to host all my content at <a class="reference external" href="https://tent.beberlei.de">https://tent.beberlei.de</a> at some day.</p>
</div>
<div class="section" id="tent-io-sounds-awesome-how-can-i-help">
<h2>Tent.io sounds awesome, how can I help?</h2>
<p>Right at the moment the tent software stack is developed by the team that also
hosts <a class="reference external" href="https://tent.is">Tent.is</a>. If all you can provide is money, then
signing up for the 12 USD per month is the way to go.</p>
<p>If you are a developer, then take a look at the <a class="reference external" href="https://github.com/tent/tent.io/wiki/Related-projects">Wiki</a> where related
projects are listed. You will find a bunch of client libraries for major
languages already, helping you to get started.</p>
<p>I suppose the major work lies in implementing Status-Post clients for all
major smartphone platforms and desktops. As well as the host of applications
that Facebook and other social networks provides:</p>
<ul class="simple">
<li>Manage and share Photo albums</li>
<li>Plan and share events</li>
<li>Managing contact data/address book</li>
<li>Resume details (Linkedin/Xing)</li>
<li>Track User Events (Timeline)</li>
<li>Sharing Music and Videos (Myspace)</li>
<li>Importing all sorts of existing content (RSS,..)</li>
</ul>
</div>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2012/10/22/a_tent_io_app__zelten_bookmarks.html#disqus_thread" data-disqus-identifier="2012/10/22/a_tent_io_app__zelten_bookmarks">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>September 04, 2012</span> 
        </div>
        <div class="section" id="using-assertions-for-validation">
<h1><a href="2012/09/04/using_assertions_for_validation.html">Using Assertions for validation</a></h1>
<p>We all know PHP is weakly typed and has some weird type-conversion rules.
This can often complicate our code checking for invalid or illegal data.
Using if/else clauses we can do all sorts of validation, but with standard
coding styles (PSR, Zend, PEAR) we end up with at least 3 lines per check,
cluttering the whole code-base.</p>
<p>Take <a class="reference external" href="http://phpazure.codeplex.com/SourceControl/changeset/view/67037#840935">this example</a> from
the old deprecated Windows Azure SDK, a method for putting a binary file into
Azures blob storage:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">putBlob</span><span class="p">(</span><span class="nv">$containerName</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$blobName</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$localFileName</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$metadata</span> <span class="o">=</span> <span class="k">array</span><span class="p">(),</span> <span class="nv">$leaseId</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$additionalHeaders</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$containerName</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Microsoft_WindowsAzure_Exception</span><span class="p">(</span><span class="s1">'Container name is not specified.'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="o">::</span><span class="na">isValidContainerName</span><span class="p">(</span><span class="nv">$containerName</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Microsoft_WindowsAzure_Exception</span><span class="p">(</span><span class="s1">'Container name does not adhere to container naming conventions. See http://msdn.microsoft.com/en-us/library/dd135715.aspx for more information.'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$blobName</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Microsoft_WindowsAzure_Exception</span><span class="p">(</span><span class="s1">'Blob name is not specified.'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$localFileName</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Microsoft_WindowsAzure_Exception</span><span class="p">(</span><span class="s1">'Local file name is not specified.'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$localFileName</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Microsoft_WindowsAzure_Exception</span><span class="p">(</span><span class="s1">'Local file not found.'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$containerName</span> <span class="o">===</span> <span class="s1">'$root'</span> <span class="o">&amp;&amp;</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$blobName</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Microsoft_WindowsAzure_Exception</span><span class="p">(</span><span class="s1">'Blobs stored in the root container can not have a name containing a forward slash (/).'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// rest of the code here</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The rest of this components public API methods look about the same. It is a
very complete validation of the input data, however its not very readable.
Instead you have 6 if branches, which increase the complexity of the method
and almost take up half the screen without even getting to the actual code.</p>
<p>The assertion pattern is really helpful here to reduce the complexity of this
code and hide the <tt class="docutils literal"><span class="pre">if/throw</span></tt> conditions into little helper methods. Have a
look at a refactored method using my <a class="reference external" href="https://github.com/beberlei/assert">Assert</a> micro-library.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">putBlob</span><span class="p">(</span><span class="nv">$containerName</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$blobName</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$localFileName</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$metadata</span> <span class="o">=</span> <span class="k">array</span><span class="p">(),</span> <span class="nv">$leaseId</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$additionalHeaders</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
<span class="p">{</span>
    <span class="nx">Assertion</span><span class="o">::</span><span class="na">notEmpty</span><span class="p">(</span><span class="nv">$containerName</span><span class="p">,</span> <span class="s1">'Container name is not specified'</span><span class="p">);</span>
    <span class="nx">self</span><span class="o">::</span><span class="na">assertValidContainerName</span><span class="p">(</span><span class="nv">$containerName</span><span class="p">);</span>
    <span class="nx">Assertion</span><span class="o">::</span><span class="na">notEmpty</span><span class="p">(</span><span class="nv">$blobName</span><span class="p">,</span> <span class="s1">'Blob name is not specified.'</span><span class="p">);</span>
    <span class="nx">Assertion</span><span class="o">::</span><span class="na">notEmpty</span><span class="p">(</span><span class="nv">$localFileName</span><span class="p">,</span> <span class="s1">'Local file name is not specified.'</span><span class="p">);</span>
    <span class="nx">Assertion</span><span class="o">::</span><span class="na">file</span><span class="p">(</span><span class="nv">$localFileName</span><span class="p">,</span> <span class="s1">'Local file name is not specified.'</span><span class="p">);</span>
    <span class="nx">self</span><span class="o">::</span><span class="na">assertValidRootContainerBlobName</span><span class="p">(</span><span class="nv">$containerName</span><span class="p">,</span> <span class="nv">$blobName</span><span class="p">);</span>

    <span class="c1">// rest of the code</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is much more readable, using two custom assertions and some general
assertions.</p>
<p>There is one risk here though, you introduce additional coupling to another
library/namespace. Especially when you start using this pattern on a large
scale, you have to make sure this assertions are <strong>VERY</strong> stable and
unit-tested.</p>
<p>That is why you should extend from <tt class="docutils literal"><span class="pre">Assertion</span></tt> and use your own class when
using the Assert library. This returns some control in your hands and even
allows you to overwrite the exception class:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\Util</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Assert\Assertion</span> <span class="k">as</span> <span class="nx">BaseAssertion</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Assertion</span> <span class="k">extends</span> <span class="nx">BaseAssertion</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">protected</span> <span class="nv">$exceptionClass</span> <span class="o">=</span> <span class="s1">'MyProject\Util\AssertionFailedException'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        <div class="categories">
            <span>
                Filed under:
                
                    <a href="categories/php.html">PHP</a>
                
            </span>
        </div>
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2012/09/04/using_assertions_for_validation.html#disqus_thread" data-disqus-identifier="2012/09/04/using_assertions_for_validation">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>August 26, 2012</span> 
        </div>
        <div class="section" id="symfony-monolog-and-different-log-types">
<h1><a href="2012/08/26/symfony__monolog_and_different_log_types.html">Symfony, Monolog and different log types</a></h1>
<p>Symfony uses the excellent Monolog library for logging everything related
to the symfony application stack. But sometimes you need a different logger
that responds differently to the log error levels. Ideally you don’t want
to reuse the application log mechanism to avoid messing with the
fingers crossed listener of Monolog, that keeps the application log files small
in case no errors occur.</p>
<p>This can be easily done with Symfonys MonologBundle with a feature called
channel. Every log handler, such as file, syslog, mail or
fingers crossed is attached to the default logger called “app”. This is
referenced by the dependency injection service called <tt class="docutils literal"><span class="pre">monolog.logger</span></tt>.</p>
<p>If you want to create a different logger service that is responsible for a
different type of your application stack, just define it using the <tt class="docutils literal"><span class="pre">channels</span></tt>
option:</p>
<div class="highlight-yaml"><pre>monolog:
    handlers:
        myfile:
            type: stream
            path: %kernel.logs_dir%/myfile.log
            channels: mychannel</pre>
</div>
<p>To actually write to <tt class="docutils literal"><span class="pre">mychannel</span></tt> you have to tag all the services that use
<tt class="docutils literal"><span class="pre">mychannel</span></tt> with the following tag:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;service</span> <span class="na">id=</span><span class="s">&quot;my_service&quot;</span> <span class="na">class=</span><span class="s">&quot;MyService&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tag</span> <span class="na">name=</span><span class="s">&quot;monolog.logger&quot;</span> <span class="na">channel=</span><span class="s">&quot;mychannel&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">&quot;service&quot;</span> <span class="na">id=</span><span class="s">&quot;logger&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/service&gt;</span>
</pre></div>
</div>
<p>With this approach you are now as flexible as with the default channel <tt class="docutils literal"><span class="pre">app</span></tt>
regarding to logging in development, testing and production environments for
example. Once there is a channel created through the DIC tag, you can actually
fetch it from the DIC with <tt class="docutils literal"><span class="pre">monolog.logger.mychannel</span></tt> in our example.
I don’t like this approach too much, because it misuses tags for modifying
arguments, where tags are actually for the services themselves. However it is
usable and works.</p>
<p>This feature is included starting with Symfony 2.1. It is <a class="reference external" href="http://symfony.com/doc/master/cookbook/logging/channels_handlers.html">documented in a
cookbook entry</a>,
however some insights of this blog post are still inside a pending Pull
Request.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2012/08/26/symfony__monolog_and_different_log_types.html#disqus_thread" data-disqus-identifier="2012/08/26/symfony__monolog_and_different_log_types">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>August 26, 2012</span> 
        </div>
        <div class="section" id="froscon-2012">
<h1><a href="2012/08/26/froscon_2012.html">FrOSCon 2012</a></h1>
<p>This years <a class="reference external" href="http://www.froscon.org">Free and Open Source Conference (FrOSCon)</a> took place this weekend in Bonn, St.  Augustin.
Because I live in Bonn, visiting the conference is a given for very many years
now. This year I also did a talk on “Architecture Design Patterns” with <a class="reference external" href="http://twitter.com/go_oh">Gordon</a> so there was an incentive to show up besides
meeting friends, all the Club Mate and <a class="reference external" href="http://www.quijote-kaffee.de">good open source coffee</a>.</p>
<p>The most interesting topic in this years conference for me has been the <a class="reference external" href="http://graylog2.org/">Graylog2</a> talk by Lennart Koopmann. Graylog is a logging server
that uses Elastic Search for persistence and searching. It is sponsored by
Xing, a pretty big german based Linkedin clone.</p>
<p>The talk <a class="reference external" href="http://programm.froscon.de/2012/events/954.html">The State of PHPUnit</a> by <a class="reference external" href="http://twitter.com/__edorian/">Volker</a> was interesting to see all the new stuff in
PHPUnit 3.7 and that it fixes a bunch of annoyances that I stumbled on myself.
I actually realized that they are so deeply rooted in my brain already, that
they constitute features for me, not something that could actually be
optimized. Well done to Volker and Sebastian to the new version.</p>
<p>Igors talk about building an HTTP server in PHP was interesting to see the
stream/socket server APIs of PHP at work. Ever since I took part in <a class="reference external" href="https://github.com/conradmueller/maexchen">the
SoCraTes 2012 Conference Maexchen UDP Bot</a> challenge I think network
programming is an interesting topic for learning about languages and
programming itself.</p>
<p>Volker did a second talk on sunday about Clean Code that was both entertaining
and interesting. He was reminding the audience that shipping the code is what
actually creates the value in our profession. Hence clean code is not about
the beauty of code itself, but its ability to be shippable, changeable and
adaptable to the business.</p>
<p>Again FrOSCon 2012 was awesome. Thank you very much especially to all the
volunteers that organized this event. It really good event to bring together
people from many different open-source communities and I already look forward
to the next FrOSCon 2013.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2012/08/26/froscon_2012.html#disqus_thread" data-disqus-identifier="2012/08/26/froscon_2012">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>August 25, 2012</span> 
        </div>
        <div class="section" id="decoupling-applications-with-domains-events">
<h1><a href="2012/08/25/decoupling_applications_with_domain_events.html">Decoupling applications with Domains Events</a></h1>
<p>In the <a class="reference external" href="http://whitewashing.de/2012/08/18/oop_business_applications__command_query_responsibility_seggregation.html">previous posts</a>
I have described 3 architectural patterns for business applications. Applying
them to your software helps you decouple the business logic from the
application/framework/UI. However given sufficient complexity, you will want to
decouple different parts of your business model from each other as well.</p>
<p>As an example, lets think of a batch process in your application that updates
orders from a CRM or logistics system:</p>
<ul class="simple">
<li>You receive an XML with full users and order representations</li>
<li>You need to update certain user fields</li>
<li>You need to update certain order fields</li>
<li>Some orders require creating accounts in different remote systems</li>
<li>If the user has not confirmed his email yet he should receive an opt-in
mail instead.</li>
<li>If the user confirms his opt-in mail, all outstanding remote accounts are
created.</li>
</ul>
<p>You can build all the steps into a single batch processing service. This will
be a particularly huge service and in violation of the <a class="reference external" href="http://en.wikipedia.org/wiki/Single_responsibility_principle">Single Responsibility
principle</a>.</p>
<p>the part with updating of users and fields has nothing to with the sending of
mails and creation of remote accounts.  We want to decouple them from each
other.</p>
<p>The first obvious choice is to decouple them into distinct services:</p>
<ul class="simple">
<li>Import Service</li>
<li>Authentication Service</li>
<li>Account Generation Service</li>
</ul>
<p>All these services have dependencies on infrastructure objects, database,
mailer and so on. We could inject the authentication and account generation
services into the Import Service, but with rising complexity this will lead to
a lasagna of services and the execution path will dig deep into this and this
is not nearly as tasty as eating real lasagna.</p>
<div class="highlight-python"><pre>ImportService
|_AuthenticationService
| |_Mailer
| |_Database
|_AccountGenerationService
| |_Database
| \_RemoteFacade
\_Database</pre>
</div>
<p>This becomes more complicated when transaction semantics need to be taken care
of. For example dependencies between mailer and database services. Also you
have to take into account that the code in entities and value objects
participating in this use-case.</p>
<p>What we want instead is a sequential execution of those nested services, but
only if the parent service executed successfully:</p>
<div class="highlight-python"><pre>ImportService
\_Database

AuthenticationService
|_Mailer
\_Database

AccountGenerationService
|_Database
\_RemoteFacade</pre>
</div>
<p>We could use an event dispatcher in all of the services to notify each other,
but the <a class="reference external" href="http://martinfowler.com/eaaDev/DomainEvent.html">DomainEvent pattern</a> does this more in a much
cleaner way:</p>
<p>Every entity is an event provider and can emit events. Whenever a transaction
is committed and an hence an operation is completed successfully, we take all
the events emitted from all entities (looking at the identity map for example)
and trigger observing event handlers. However if the operation fails, we do not
trigger these event handlers.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">Order</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">EventProvider</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">importData</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 1. do something with $data</span>

        <span class="c1">// 2. raise event</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">raise</span><span class="p">(</span><span class="k">new</span> <span class="nx">OrderImportCompleted</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s2">&quot;id&quot;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span> <span class="o">=&gt;</span> <span class="nv">$data</span>
        <span class="p">)));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The Event provider trait aggregates all the events, and offers
and API for external services to pull them from the entity:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nx">trait</span> <span class="nx">EventProvider</span> <span class="k">implements</span> <span class="nx">EventProviderInterface</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$emittedEvents</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">raise</span><span class="p">(</span><span class="nx">DomainEvent</span> <span class="nx">Event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getMessageHeader</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">setEntity</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">emittedEvents</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$event</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">dequeueEmittedEvents</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$events</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">emittedEvents</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">emittedEvents</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$events</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Our infrastructure must then trigger event handlers, based
on the event names. It will use <tt class="docutils literal"><span class="pre">dequeueEmittedEvents</span></tt> and making
sure the events are not emitted multiple times.</p>
<p>For reasons described below, we want the following command/event chain to happen in our system:</p>
<ul class="simple">
<li>Command executes</li>
<li>Entities emit events</li>
<li>Command transaction succeeds</li>
<li>Events trigger event handlers</li>
<li>Event handlers execute more commands</li>
<li>Restart from 1.</li>
</ul>
<p>With this approach we can decouple all services from each other and avoid
deep nesting in each other. Yet we still have transactional dependencies,
by dropping all events when the parent command fails. Transactions over
multiple commands will not have ACID properties though, instead you will have
to look into <a class="reference external" href="http://queue.acm.org/detail.cfm?id=1394128">BASE transactions</a>
that are important in systems with eventual consistency. This is one downside
that you need to take into account.</p>
<p>The Domain Event pattern is a prerequisite for full blown <a class="reference external" href="http://queue.acm.org/detail.cfm?id=1394128">CQRS</a>. My <a class="reference external" href="https://github.com/beberlei/litecqrs-php">LiteCQRS</a> library includes a simple
implementation of DomainEvent and EventProvider classes and integration into
Symfony and Doctrine ORM. Generally this pattern is very easy to implement
though, so that you can just have a look at the implementation and take the
best parts for your own.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2012/08/25/decoupling_applications_with_domain_events.html#disqus_thread" data-disqus-identifier="2012/08/25/decoupling_applications_with_domain_events">Leave a comment</a>
        </div>
    </div>
    
    <div class="related">
        <ul>
            <li class="right">
                <a href="page1.html">Older</a> &raquo; 
            </li>
        </ul>
    </div>
    <div class="archive_link">
        <a href="archive.html"> &mdash; Blog Archive &mdash; </a>
    </div>


            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'whitewashing';
                var disqus_url = 'http://www.whitewashing.de/index.html';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>         
        </div>
      </div>
    </div>

    <div class="span-24 last">
        
          
        
    </div>
</div>

      <div class="clearer"></div>
    </div>
<div class="container">
    <div class="span-24 content">
        <div class="footer">
            &copy; Copyright 2008-2012, Benjamin Eberlei.
            Powered by <a href="http://www.tinkerer.me/">Tinkerer</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.

        <script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script>
        </div>
    </div>
</div>

  </body>
</html>